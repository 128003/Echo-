<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSK Ultrasound Report Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* 導航區塊 */
        .nav-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .part-btn { margin: 5px; font-weight: 600; min-width: 100px; }
        .part-btn.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        
        /* 內容區塊 */
        .content-section { display: none; } /* 預設隱藏 */
        .content-section.active { display: block; animation: fadeIn 0.3s; }
        
        .card-header-custom { background-color: #2c3e50; color: white; font-weight: bold; padding: 10px 15px; border-radius: 8px 8px 0 0; }
        .sub-header { background-color: #e9ecef; color: #495057; padding: 8px 15px; font-weight: 700; border-left: 5px solid #0d6efd; margin-top: 15px; margin-bottom: 10px; }
        
        /* 選項樣式 */
        .finding-row { padding: 10px 15px; border-bottom: 1px solid #eee; background: white; }
        .structure-label { font-weight: 700; color: #0d6efd; display: block; margin-bottom: 5px; }
        .sub-options { display: none; margin-left: 20px; padding: 8px; background-color: #f8f9fa; border-left: 2px solid #adb5bd; margin-top: 5px; border-radius: 4px; }
        
        /* 報告輸出 */
        .report-box { background: #fff; border: 2px solid #2c3e50; padding: 20px; min-height: 150px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h3 class="text-center mb-4 fw-bold text-dark">Musculoskeletal Ultrasound Report</h3>

    <div class="nav-card">
        <div class="row align-items-center mb-3">
            <div class="col-md-2 fw-bold fs-5">Side:</div>
            <div class="col-md-10">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="side" id="sideR" value="Right" checked>
                    <label class="btn btn-outline-primary" for="sideR">Right</label>

                    <input type="radio" class="btn-check" name="side" id="sideL" value="Left">
                    <label class="btn btn-outline-primary" for="sideL">Left</label>
                </div>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col-md-2 fw-bold fs-5">Region:</div>
            <div class="col-md-10">
                <button class="btn btn-outline-secondary part-btn active" onclick="switchPart('shoulder')">Shoulder</button>
                <button class="btn btn-outline-secondary part-btn" onclick="switchPart('elbow')">Elbow</button>
                <button class="btn btn-outline-secondary part-btn" onclick="switchPart('wrist')">Wrist</button>
                <button class="btn btn-outline-secondary part-btn" onclick="switchPart('knee')">Knee</button>
                <button class="btn btn-outline-secondary part-btn" onclick="switchPart('ankle')">Ankle</button>
                <button class="btn btn-outline-secondary part-btn" onclick="switchPart('mass')">Mass</button>
            </div>
        </div>
    </div>

    <div id="section_shoulder" class="content-section active">
        <div class="card shadow-sm mb-3">
            <div class="card-header-custom">I. Shoulder Findings</div>
            <div class="card-body p-0">
                
                <div class="finding-row">
                    <span class="structure-label">Biceps brachialis long head</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Normal</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="heterogenous and hypoechoic change with loss of fibrillar pattern"> Heterogenous/Hypoechoic</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="peritendinous effusion (target sign)"> Target sign</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="hypervascularity"> Hypervascularity</label>
                    <div class="d-inline-block">
                        <label class="me-3"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_bic_tear"> Tear</label>
                        <div id="sub_bic_tear" class="sub-options">
                            <label><input type="radio" name="bic_tear" value="partial thickness tear" checked> Partial thickness</label>
                            <label><input type="radio" name="bic_tear" value="full thickness tear"> Full thickness</label>
                        </div>
                    </div>
                </div>

                <div class="finding-row">
                    <span class="structure-label">AC Joint</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Intact</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="OA change"> OA change</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="buldging (>3mm)"> Buldging (>3mm)</label>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Subscapularis</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Intact</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="hypoechoic and heterogenous change"> Hypoechoic/Heterogenous</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="poorly visible due to limited external rotation"> Poorly visible</label>
                    
                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_subscap_calc"> Calcific deposit</label>
                        <div id="sub_subscap_calc" class="sub-options d-inline-block">
                            <span class="text-muted small">Type: </span>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="arc-shape"> Arc-shape</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="fragmented"> Fragmented</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="nodular"> Nodular</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="cystic"> Cystic</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="milky"> Milky</label>
                        </div>
                    </div>

                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_subscap_tear"> Tear</label>
                        <div id="sub_subscap_tear" class="sub-options d-inline-block">
                            <label class="me-2"><input type="radio" name="subscap_tear" value="partial thickness tear" checked> Partial</label>
                            <label class="me-2"><input type="radio" name="subscap_tear" value="full thickness tear"> Full</label>
                            <label class="me-2"><input type="radio" name="subscap_tear" value="complete tear"> Complete</label>
                            <label class="ms-2 border-start ps-2"><input type="checkbox" class="val-sub-extra" value="with hypervascularity"> +Hypervascularity</label>
                        </div>
                    </div>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Supraspinatus</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Intact</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="increased thickness (>8mm)"> Increased thickness</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="hypoechoic and heterogenous change"> Hypoechoic/Heterogenous</label>
                    
                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_supra_tear"> Tear</label>
                        <div id="sub_supra_tear" class="sub-options">
                            <div class="mb-1">
                                <span class="text-muted small">Type: </span>
                                <label class="me-2"><input type="checkbox" class="val-sub" value="bursal side"> Bursal</label>
                                <label class="me-2"><input type="checkbox" class="val-sub" value="articular side"> Articular</label>
                                <label class="me-2"><input type="checkbox" class="val-sub" value="intrasubstance"> Intrasubstance</label>
                                <label class="me-2"><input type="checkbox" class="val-sub" value="full-thickness"> Full-thickness</label>
                            </div>
                            <div class="mb-1">
                                <span class="text-muted small">Features: </span>
                                <label class="me-2"><input type="checkbox" class="val-sub-feat" value="interface sign"> Interface sign</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-feat" value="loss tendon volume/deltoid herniation"> Deltoid herniation</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-feat" value="empty head with muscle retraction"> Empty head/Retraction</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-feat" value="hypervascularity"> Hypervascularity</label>
                            </div>
                            <div>
                                <span class="text-muted small">Location: </span>
                                <label class="me-2"><input type="checkbox" class="val-sub-loc" value="distal"> Distal</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-loc" value="proximal"> Proximal</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-loc" value="anterior"> Anterior</label>
                                <label class="me-2"><input type="checkbox" class="val-sub-loc" value="posterior"> Posterior</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_supra_calc"> Calcific deposit</label>
                        <div id="sub_supra_calc" class="sub-options d-inline-block">
                            <label class="me-2"><input type="checkbox" class="val-sub" value="arc-shape"> Arc-shape</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="fragmented"> Fragmented</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="nodular"> Nodular</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="cystic"> Cystic</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="milky"> Milky</label>
                            <label class="ms-2 border-start ps-2"><input type="checkbox" class="val-sub-extra" value="with hypervascularity"> +Hypervascularity</label>
                        </div>
                    </div>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Subdeltoid bursa</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="increased thickness (>2mm)"> Increased thickness</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="fluid accumulation"> Fluid accumulation</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="hypervascularity"> Hypervascularity</label>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Infraspinatus tendon</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Intact</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="hypoechoic and heterogenous change"> Hypoechoic/Heterogenous</label>
                    
                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_infra_tear"> Tear</label>
                        <div id="sub_infra_tear" class="sub-options d-inline-block">
                            <label class="me-2"><input type="radio" name="infra_tear" value="partial thickness tear" checked> Partial</label>
                            <label class="me-2"><input type="radio" name="infra_tear" value="full thickness tear"> Full</label>
                            <label class="ms-2 border-start ps-2"><input type="checkbox" class="val-sub-extra" value="with hypervascularity"> +Hypervascularity</label>
                        </div>
                    </div>

                    <div class="d-block mt-1">
                        <label class="me-3 fw-bold"><input type="checkbox" class="form-check-input val toggle-sub" data-target="sub_infra_calc"> Calcific deposit</label>
                        <div id="sub_infra_calc" class="sub-options d-inline-block">
                            <label class="me-2"><input type="checkbox" class="val-sub" value="arc-shape"> Arc-shape</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="fragmented"> Fragmented</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="nodular"> Nodular</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="cystic"> Cystic</label>
                            <label class="me-2"><input type="checkbox" class="val-sub" value="milky"> Milky</label>
                            <label class="ms-2 border-start ps-2"><input type="checkbox" class="val-sub-extra" value="with hypervascularity"> +Hypervascularity</label>
                        </div>
                    </div>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Posterior Labrum</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input struct-intact" value="intact"> Intact (Normal)</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="fluid accumulation"> Fluid accumulation</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="increased synovial substance during the dynamic study"> Increased synovial substance (Dynamic)</label>
                </div>

                <div class="finding-row">
                    <span class="structure-label">Others</span>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="irregularity of greater tubercle of humeral head"> Irregularity of GT</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="increased thickness of IGHL (>4mm)"> IGHL > 4mm</label>
                    <label class="me-3"><input type="checkbox" class="form-check-input val" value="trivial depression of humeral head and impingement of subdeltoid bursa during the dynamic study"> Dynamic Impingement</label>
                    <div class="mt-2">
                         <input type="text" class="form-control" id="sh_other_text" placeholder="Free text input...">
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-success">
            <div class="card-header-custom bg-success">II. Shoulder Impression</div>
            <div class="card-body">
                
                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_supra_tear"> Supraspinatus Tear</label>
                    <div id="imp_sub_supra_tear" class="sub-options d-inline-block">
                        <select class="form-select form-select-sm d-inline-block w-auto me-1" id="imp_supra_loc">
                            <option value="">(Location)</option>
                            <option value="distal">Distal</option>
                            <option value="proximal">Proximal</option>
                        </select>
                        <select class="form-select form-select-sm d-inline-block w-auto me-1" id="imp_supra_type">
                            <option value="partial thickness tear">Partial thickness</option>
                            <option value="full thickness tear">Full thickness</option>
                            <option value="complete tear">Complete</option>
                        </select>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="imp_supra_side">
                            <option value="">(Side)</option>
                            <option value="bursal side">Bursal side</option>
                            <option value="articular side">Articular side</option>
                            <option value="intrasubstance">Intrasubstance</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_supra_path"> Supraspinatus Pathology</label>
                    <div id="imp_sub_supra_path" class="sub-options d-inline-block">
                         <label class="me-2"><input type="radio" name="imp_supra_path_val" value="tendinopathy" checked> Tendinopathy</label>
                         <label class="me-2"><input type="radio" name="imp_supra_path_val" value="calcific tendonitis"> Calcific tendonitis</label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_infra_tear"> Infraspinatus Tear</label>
                    <div id="imp_sub_infra_tear" class="sub-options d-inline-block">
                        <label class="me-2"><input type="radio" name="imp_infra_tear_val" value="partial thickness tear" checked> Partial</label>
                        <label class="me-2"><input type="radio" name="imp_infra_tear_val" value="full thickness tear"> Full</label>
                        <label class="me-2"><input type="radio" name="imp_infra_tear_val" value="complete tear"> Complete</label>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_infra_path"> Infraspinatus Pathology</label>
                    <div id="imp_sub_infra_path" class="sub-options d-inline-block">
                         <label class="me-2"><input type="radio" name="imp_infra_path_val" value="tendinopathy" checked> Tendinopathy</label>
                         <label class="me-2"><input type="radio" name="imp_infra_path_val" value="calcific tendonitis"> Calcific tendonitis</label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_subscap_tear"> Subscapularis Tear</label>
                    <div id="imp_sub_subscap_tear" class="sub-options d-inline-block">
                        <label class="me-2"><input type="radio" name="imp_subscap_tear_val" value="partial thickness tear" checked> Partial</label>
                        <label class="me-2"><input type="radio" name="imp_subscap_tear_val" value="full thickness tear"> Full</label>
                        <label class="me-2"><input type="radio" name="imp_subscap_tear_val" value="complete tear"> Complete</label>
                    </div>
                </div>
                 <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_subscap_path"> Subscapularis Pathology</label>
                    <div id="imp_sub_subscap_path" class="sub-options d-inline-block">
                         <label class="me-2"><input type="radio" name="imp_subscap_path_val" value="tendinopathy" checked> Tendinopathy</label>
                         <label class="me-2"><input type="radio" name="imp_subscap_path_val" value="calcific tendonitis"> Calcific tendonitis</label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="fw-bold"><input type="checkbox" class="imp-check toggle-sub" data-target="imp_sub_bic"> Biceps brachialis long head</label>
                    <div id="imp_sub_bic" class="sub-options d-inline-block">
                         <label class="me-2"><input type="radio" name="imp_bic_val" value="tenosynovitis" checked> Tenosynovitis</label>
                         <label class="me-2"><input type="radio" name="imp_bic_val" value="tendinopathy"> Tendinopathy</label>
                         <label class="me-2"><input type="radio" name="imp_bic_val" value="partial tear"> Partial Tear</label>
                         <label class="me-2"><input type="radio" name="imp_bic_val" value="complete tear"> Complete Tear</label>
                    </div>
                </div>

                <div class="mb-2">
                     <label class="fw-bold"><input type="checkbox" class="imp-check" value="Subacromial-subdeltoid bursopathy/bursitis"> Subacromial-subdeltoid bursopathy/bursitis</label>
                </div>
                <div class="mb-2">
                     <label class="fw-bold"><input type="checkbox" class="imp-check" value="Frozen shoulder was compatible"> Frozen shoulder was compatible</label>
                </div>
                
                <div class="mt-2">
                    <label class="fw-bold">Others:</label>
                    <input type="text" class="form-control" id="imp_other_text" placeholder="Other diagnosis...">
                </div>
            </div>
        </div>
    </div>

    <div id="section_elbow" class="content-section">
        <div class="alert alert-secondary">Elbow section selected. (Logic preserved from previous request)</div>
        </div>
    <div id="section_wrist" class="content-section"><div class="alert alert-secondary">Wrist section selected.</div></div>
    <div id="section_knee" class="content-section"><div class="alert alert-secondary">Knee section selected.</div></div>
    <div id="section_ankle" class="content-section"><div class="alert alert-secondary">Ankle section selected.</div></div>
    <div id="section_mass" class="content-section"><div class="alert alert-secondary">Mass section selected.</div></div>


    <button class="btn btn-generate mt-4" onclick="generateReport()">Generate Report</button>
    
    <div class="mt-4">
        <h5>Final Report:</h5>
        <div id="output" class="report-box shadow-sm"></div>
    </div>
</div>

<script>
    // --- UI Logic ---
    function switchPart(partId) {
        // Toggle buttons
        document.querySelectorAll('.part-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Toggle Sections
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById('section_' + partId).classList.add('active');
    }

    // Toggle Sub-options
    document.querySelectorAll('.toggle-sub').forEach(cb => {
        cb.addEventListener('change', function() {
            const target = document.getElementById(this.dataset.target);
            target.style.display = this.checked ? 'inline-block' : 'none';
        });
    });

    // --- Generator Logic ---
    function generateReport() {
        const side = document.querySelector('input[name="side"]:checked').value;
        const activePart = document.querySelector('.content-section.active').id;
        
        let report = "";

        if (activePart === 'section_shoulder') {
            report += generateShoulderFindings(side);
            report += "\n" + generateShoulderImpression(side);
        } else {
            report += `[${activePart.replace('section_', '').toUpperCase()}] Report generation placeholder.`;
        }

        document.getElementById('output').innerText = report;
    }

    function generateShoulderFindings(side) {
        let text = "";
        const container = document.getElementById('section_shoulder');
        
        // --- 1. Smart "All Intact" Check ---
        const intactIds = container.querySelectorAll('.struct-intact:checked');
        const anyPathology = container.querySelectorAll('.val:checked').length > 0;
        const totalStructs = 6; // Biceps, AC, Subscap, Supra, Infra, Labrum
        
        // Logic: All 6 "Intact" boxes checked AND No other findings checked
        if (intactIds.length === totalStructs && !anyPathology) {
             return `Findings:\nintact biceps LH tendon, AC joint, subscapularis, supraspinatus tendon, infraspinatus tendon and posterior labrum\n`;
        }

        // --- 2. Individual Findings Generation ---
        let findingsList = [];

        container.querySelectorAll('.finding-row').forEach(row => {
            const label = row.querySelector('.structure-label').innerText;
            let rowVals = [];

            // Intact Checkbox
            if (row.querySelector('.struct-intact') && row.querySelector('.struct-intact').checked) {
                rowVals.push("intact");
            }

            // Normal Values
            row.querySelectorAll('.val:checked').forEach(cb => {
                if(cb.classList.contains('toggle-sub')) return; // Skip toggle parents
                rowVals.push(cb.value);
            });

            // Specific Sub-Logics
            
            // Subscapularis Calcific
            if (row.querySelector('[data-target="sub_subscap_calc"]:checked')) {
                let types = Array.from(document.querySelectorAll('#sub_subscap_calc .val-sub:checked')).map(c => c.value);
                let desc = "calcific deposit along the subscapularis tendon fibers with partial shadowing";
                if(types.length > 0) desc += ` (${types.join(', ')})`;
                rowVals.push(desc);
            }
            // Subscapularis Tear
            if (row.querySelector('[data-target="sub_subscap_tear"]:checked')) {
                let tearType = document.querySelector('input[name="subscap_tear"]:checked').value;
                let extra = document.querySelector('#sub_subscap_tear .val-sub-extra:checked');
                if(extra) tearType += " with hypervascularity";
                rowVals.push("tear (" + tearType + ")");
            }

            // Supraspinatus Tear
            if (row.querySelector('[data-target="sub_supra_tear"]:checked')) {
                let subDiv = document.getElementById('sub_supra_tear');
                let types = Array.from(subDiv.querySelectorAll('.val-sub:checked')).map(c => c.value);
                let feats = Array.from(subDiv.querySelectorAll('.val-sub-feat:checked')).map(c => "with " + c.value);
                let locs = Array.from(subDiv.querySelectorAll('.val-sub-loc:checked')).map(c => c.value);
                
                let str = "tear";
                if(types.length > 0) str += ` (${types.join(', ')})`;
                if(feats.length > 0) str += ` ${feats.join(', ')}`;
                if(locs.length > 0) str += ` at ${locs.join('/')} part`;
                rowVals.push(str);
            }
            // Supraspinatus Calcific
            if (row.querySelector('[data-target="sub_supra_calc"]:checked')) {
                let types = Array.from(document.querySelectorAll('#sub_supra_calc .val-sub:checked')).map(c => c.value);
                let extra = document.querySelector('#sub_supra_calc .val-sub-extra:checked');
                let desc = "calcific deposit along the supraspinatus tendon fibers with partial shadowing";
                if(types.length > 0) desc += ` (${types.join(', ')})`;
                if(extra) desc += " with hypervascularity";
                rowVals.push(desc);
            }

            // Infraspinatus Tear
            if (row.querySelector('[data-target="sub_infra_tear"]:checked')) {
                let tearType = document.querySelector('input[name="infra_tear"]:checked').value;
                let extra = document.querySelector('#sub_infra_tear .val-sub-extra:checked');
                if(extra) tearType += ", with hypervascularity";
                rowVals.push("tear (" + tearType + ")");
            }
            // Infraspinatus Calcific
            if (row.querySelector('[data-target="sub_infra_calc"]:checked')) {
                let types = Array.from(document.querySelectorAll('#sub_infra_calc .val-sub:checked')).map(c => c.value);
                let extra = document.querySelector('#sub_infra_calc .val-sub-extra:checked');
                let desc = "calcific deposit along the infraspinatus tendon fibers with partial shadowing";
                if(types.length > 0) desc += ` (${types.join(', ')})`;
                if(extra) desc += " with hypervascularity";
                rowVals.push(desc);
            }

            // Biceps Tear
            if (row.querySelector('[data-target="sub_bic_tear"]:checked')) {
                let tearType = document.querySelector('input[name="bic_tear"]:checked').value;
                rowVals.push("tear (" + tearType + ")");
            }

            // Others text
            if(label === "Others") {
                 let freeText = document.getElementById('sh_other_text').value;
                 if(freeText) rowVals.push(freeText);
            }

            if(rowVals.length > 0) {
                findingsList.push(`${label}: ${rowVals.join(', ')}`);
            }
        });

        if(findingsList.length > 0) {
            text += "Findings:\n" + findingsList.join('\n') + "\n";
        }
        return text;
    }

    function generateShoulderImpression(side) {
        let imps = [];
        
        // Supraspinatus Tear
        if (document.querySelector('[data-target="imp_sub_supra_tear"]:checked')) {
            let loc = document.getElementById('imp_supra_loc').value;
            let type = document.getElementById('imp_supra_type').value;
            let subSide = document.getElementById('imp_supra_side').value;
            let str = `${side} Supraspinatus ${type}`;
            if(loc) str += ` (${loc})`;
            if(subSide) str += ` (${subSide})`;
            imps.push(str);
        }
        // Supraspinatus Path
        if (document.querySelector('[data-target="imp_sub_supra_path"]:checked')) {
            let val = document.querySelector('input[name="imp_supra_path_val"]:checked').value;
            imps.push(`${side} Supraspinatus ${val}`);
        }
        // Infraspinatus Tear
        if (document.querySelector('[data-target="imp_sub_infra_tear"]:checked')) {
            let val = document.querySelector('input[name="imp_infra_tear_val"]:checked').value;
            imps.push(`${side} Infraspinatus ${val}`);
        }
        // Infraspinatus Path
        if (document.querySelector('[data-target="imp_sub_infra_path"]:checked')) {
            let val = document.querySelector('input[name="imp_infra_path_val"]:checked').value;
            imps.push(`${side} Infraspinatus ${val}`);
        }
        // Subscapularis Tear
        if (document.querySelector('[data-target="imp_sub_subscap_tear"]:checked')) {
            let val = document.querySelector('input[name="imp_subscap_tear_val"]:checked').value;
            imps.push(`${side} Subscapularis ${val}`);
        }
        // Subscapularis Path
        if (document.querySelector('[data-target="imp_sub_subscap_path"]:checked')) {
            let val = document.querySelector('input[name="imp_subscap_path_val"]:checked').value;
            imps.push(`${side} Subscapularis ${val}`);
        }
        // Biceps
        if (document.querySelector('[data-target="imp_sub_bic"]:checked')) {
            let val = document.querySelector('input[name="imp_bic_val"]:checked').value;
            imps.push(`${side} Biceps brachialis long head ${val}`);
        }

        // Standard checkboxes
        document.querySelectorAll('.imp-check:checked').forEach(cb => {
            if(!cb.classList.contains('toggle-sub')) {
                imps.push(`${side} ${cb.value}`);
            }
        });

        // Other Text
        let otherImp = document.getElementById('imp_other_text').value;
        if(otherImp) imps.push(`${side} ${otherImp}`);

        if(imps.length === 0) return "";

        let text = `Impression:\nThis ultrasonography study of ${side} shoulder showed:\n`;
        imps.forEach(imp => text += `* ${imp}\n`);
        text += "Please correlate with clinical presentation.";
        return text;
    }
</script>

</body>
</html>
